#include <stdio.h>
#include <pthread.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <sys/un.h>
#include <string.h>
#include <stdlib.h>
#include "tableManager.h"
#include "dealer.h"
#include "bouncer.h"
#include "playerServant.h"

#define BOUNCER_NAME "/tmp/pokerbouncer"

static char thePokerTable[] = {36, 36, 36, 36, 36, 36, 36, 36, 92, 32, 36, 36, 92, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 36, 36, 36, 36, 36, 36, 36, 92, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 36, 36, 92, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 36, 36, 36, 36, 36, 36, 36, 36, 92, 32, 32, 32, 32, 32, 32, 32, 32, 36, 36, 92, 32, 32, 32, 32, 32, 32, 32, 36, 36, 92, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 92, 95, 95, 36, 36, 32, 32, 95, 95, 124, 36, 36, 32, 124, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 36, 36, 32, 32, 95, 95, 36, 36, 92, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 36, 36, 32, 124, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 92, 95, 95, 36, 36, 32, 32, 95, 95, 124, 32, 32, 32, 32, 32, 32, 32, 36, 36, 32, 124, 32, 32, 32, 32, 32, 32, 36, 36, 32, 124, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 36, 36, 32, 124, 32, 32, 32, 36, 36, 36, 36, 36, 36, 36, 92, 32, 32, 32, 36, 36, 36, 36, 36, 36, 92, 32, 32, 36, 36, 32, 124, 32, 32, 36, 36, 32, 124, 32, 36, 36, 36, 36, 36, 36, 92, 32, 32, 36, 36, 32, 124, 32, 32, 36, 36, 92, 32, 32, 36, 36, 36, 36, 36, 36, 92, 32, 32, 32, 36, 36, 36, 36, 36, 36, 92, 32, 32, 36, 36, 32, 124, 32, 36, 36, 36, 36, 36, 36, 92, 32, 32, 36, 36, 36, 36, 36, 36, 36, 92, 32, 32, 36, 36, 32, 124, 32, 36, 36, 36, 36, 36, 36, 92, 32, 32, 10, 32, 32, 32, 36, 36, 32, 124, 32, 32, 32, 36, 36, 32, 32, 95, 95, 36, 36, 92, 32, 36, 36, 32, 32, 95, 95, 36, 36, 92, 32, 36, 36, 36, 36, 36, 36, 36, 32, 32, 124, 36, 36, 32, 32, 95, 95, 36, 36, 92, 32, 36, 36, 32, 124, 32, 36, 36, 32, 32, 124, 36, 36, 32, 32, 95, 95, 36, 36, 92, 32, 36, 36, 32, 32, 95, 95, 36, 36, 92, 32, 36, 36, 32, 124, 32, 92, 95, 95, 95, 95, 36, 36, 92, 32, 36, 36, 32, 32, 95, 95, 36, 36, 92, 32, 36, 36, 32, 124, 36, 36, 32, 32, 95, 95, 36, 36, 92, 32, 10, 32, 32, 32, 36, 36, 32, 124, 32, 32, 32, 36, 36, 32, 124, 32, 32, 36, 36, 32, 124, 36, 36, 36, 36, 36, 36, 36, 36, 32, 124, 36, 36, 32, 32, 95, 95, 95, 95, 47, 32, 36, 36, 32, 47, 32, 32, 36, 36, 32, 124, 36, 36, 36, 36, 36, 36, 32, 32, 47, 32, 36, 36, 36, 36, 36, 36, 36, 36, 32, 124, 36, 36, 32, 124, 32, 32, 92, 95, 95, 124, 36, 36, 32, 124, 32, 36, 36, 36, 36, 36, 36, 36, 32, 124, 36, 36, 32, 124, 32, 32, 36, 36, 32, 124, 36, 36, 32, 124, 36, 36, 36, 36, 36, 36, 36, 36, 32, 124, 10, 32, 32, 32, 36, 36, 32, 124, 32, 32, 32, 36, 36, 32, 124, 32, 32, 36, 36, 32, 124, 36, 36, 32, 32, 32, 95, 95, 95, 95, 124, 36, 36, 32, 124, 32, 32, 32, 32, 32, 32, 36, 36, 32, 124, 32, 32, 36, 36, 32, 124, 36, 36, 32, 32, 95, 36, 36, 60, 32, 32, 36, 36, 32, 32, 32, 95, 95, 95, 95, 124, 36, 36, 32, 124, 32, 32, 32, 32, 32, 32, 36, 36, 32, 124, 36, 36, 32, 32, 95, 95, 36, 36, 32, 124, 36, 36, 32, 124, 32, 32, 36, 36, 32, 124, 36, 36, 32, 124, 36, 36, 32, 32, 32, 95, 95, 95, 95, 124, 10, 32, 32, 32, 36, 36, 32, 124, 32, 32, 32, 36, 36, 32, 124, 32, 32, 36, 36, 32, 124, 92, 36, 36, 36, 36, 36, 36, 36, 92, 32, 36, 36, 32, 124, 32, 32, 32, 32, 32, 32, 92, 36, 36, 36, 36, 36, 36, 32, 32, 124, 36, 36, 32, 124, 32, 92, 36, 36, 92, 32, 92, 36, 36, 36, 36, 36, 36, 36, 92, 32, 36, 36, 32, 124, 32, 32, 32, 32, 32, 32, 36, 36, 32, 124, 92, 36, 36, 36, 36, 36, 36, 36, 32, 124, 36, 36, 36, 36, 36, 36, 36, 32, 32, 124, 36, 36, 32, 124, 92, 36, 36, 36, 36, 36, 36, 36, 92, 32, 10, 32, 32, 32, 92, 95, 95, 124, 32, 32, 32, 92, 95, 95, 124, 32, 32, 92, 95, 95, 124, 32, 92, 95, 95, 95, 95, 95, 95, 95, 124, 92, 95, 95, 124, 32, 32, 32, 32, 32, 32, 32, 92, 95, 95, 95, 95, 95, 95, 47, 32, 92, 95, 95, 124, 32, 32, 92, 95, 95, 124, 32, 92, 95, 95, 95, 95, 95, 95, 95, 124, 92, 95, 95, 124, 32, 32, 32, 32, 32, 32, 92, 95, 95, 124, 32, 92, 95, 95, 95, 95, 95, 95, 95, 124, 92, 95, 95, 95, 95, 95, 95, 95, 47, 32, 92, 95, 95, 124, 32, 92, 95, 95, 95, 95, 95, 95, 95, 124};

static game_state_t* gameState;

int main(int argc, char** argv)
{
    printf("Welcome to\n%s\n", thePokerTable);

    gameState = malloc(sizeof(game_state_t));
    pthread_mutex_init(&(gameState->consoleMutex), NULL);

    initializeDealer(gameState);
    initializeBouncer(gameState);
    initializePlayers(gameState);

    pthread_t bouncer = 0;
    pthread_t dealer = 0;

    pthread_create(&bouncer, NULL, bouncerEntry, (void*)0);

    char buffer[100];
    buffer[0] = 0;

    while (strcmp(buffer, "quit\n") != 0)
    {
        fgets(buffer, 100, stdin);
        if (strcmp(buffer, "start\n") == 0)
        {
            pthread_mutex_lock(&(gameState->consoleMutex));
            if (gameState->table.isActive)
            {
                printf("MANAGER: The game is already running\n");
            }
            else
            {
                if (gameState->playerCount < 2)
                {
                    printf("MANAGER: There are not enough players in the lobby. Try again later\n");
                }
                else
                {
                    printf("MANAGER: The game is starting\n");
                    //First time starting: Create the dealer thread
                    if (dealer == 0)
                    {
                        pthread_create(&dealer, NULL, dealerEntry, (void*)0);
                    }
                    gameState->table.isActive = 1;
                }
            }
            pthread_mutex_unlock(&(gameState->consoleMutex));
        }
    }
    pthread_join(dealer, NULL);
    pthread_join(bouncer, NULL);
    free(gameState);
}